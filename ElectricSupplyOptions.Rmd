---
title: "TSP Energy Supply Modeling"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r Data Setup, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

# Load packages 
my_packages <- c("tidyverse", "vroom" , "timetk", "janitor" , "glue" , "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "formattable", "scales", "kable", "kableExtra", "dplyr")   

invisible( lapply(my_packages, require, character.only = TRUE))

#Set up environment 
place <- "Home"  #Where are we working today. 
# place <- "work"

if (place == "Home"){setwd("C:/Users/paulr/Documents/R/ElectricSupplyOptions")} else {setwd("C:/Users/prode/Documents/R/ElectricSupplyOptions")}

if (!file.exists("data")) { dir.create("data")}
if (!file.exists("NYSISO_data")) { dir.create("NYSISO_data")}

rm(place, my_packages ) #Clean up

options(dplyr.summarise.inform = FALSE)  # Suppress text in Knit printout. 
```

```{r Data Read, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

# Read in data

do.call(rbind, lapply(list.files(pattern = ".csv"), read_csv)) -> NYSISO_data
NYSISO_data$`Eastern Date Hour` <- ymd_hms(NYSISO_data$`Eastern Date Hour`)
colnames(NYSISO_data)[1] <- "TimeStamp"

"Comp520" <- read_excel("data/520 Madison.xlsx",skip = 1, col_types = c("date", "numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric" ) , col_names = c("TimeStamp", "A", "B", "C", "D", "E", "F", "G", "H"), na = "NA") %>% 
  mutate("Building" = "520 Madison Avenue", .before=1) %>%  
  mutate("Elect" = A + B + C + D + E + F + G + H, .keep = "unused")  
 
Comp520 %>% 
  select(TimeStamp) %>% 
  filter(minute(TimeStamp) == 0 & second(TimeStamp) == 0)-> Comp520a

Comp520a <- Comp520a[complete.cases(Comp520a),] 

Calpine_Shaped_Block  <- read_excel("C:/Users/paulr/Documents/R/ElectricSupplyOptions/Calpine Pricing 11.1.2022.xlsx", sheet = "NY", range = "B3:K10" )

Calpine_Seasonal_Blocks  <- read_excel("C:/Users/paulr/Documents/R/ElectricSupplyOptions/Calpine Pricing 11.1.2022.xlsx", sheet = "NY", range = "B13:K20" )

Comp520 %>%
  group_by(y = year(TimeStamp), m = month(TimeStamp),d = day(TimeStamp), h = hour(TimeStamp)) %>% 
  summarise( "Elect" = sum(Elect)) %>% 
  mutate(TimeStamp = paste(y, m, d, sep = '-')) %>% 
  mutate(TimeStamp = paste( TimeStamp, h, sep = " ")) %>% 
  mutate(TimeStamp = paste( TimeStamp, ':00:00', sep = "")) %>% 
  mutate(TimeStamp = ymd_hms(TimeStamp)) -> Comp520

Comp520[c(5:6)] -> Comp520

rm(Comp520a, Comp520b, Comp520c ) #Clean up

inner_join(Comp520, NYSISO_data, by = "TimeStamp") %>% 
  na.omit() -> ISOCOMP_data
ISOCOMP_data <- unique(ISOCOMP_data)
ISOCOMP_data %>% 
  select(c(2,1,6)) -> ISOCOMP_data
colnames(ISOCOMP_data) <- c("TimeStamp", "Energy", "LBMP")



# Put scenario here

 ISOCOMP_data %>% 
    mutate('UnitCost50_50' = (0.5 * LBMP) + (0.5 * 83.13)) %>% 
    mutate('UnitCostFixed' = 81.80 ) %>%
    mutate('HourlyCostFixed' = (Energy * UnitCostFixed / 1000) ) %>% 
    mutate('HourlyCost50_50' = (Energy * UnitCost50_50 / 1000 ) ) %>% 
    group_by(month(TimeStamp)) %>% 
    summarise('EnergyIndexCost' = sum(LBMP), 'Monthly_kWh' = sum(Energy), 'EnergyCost50_50' = sum(HourlyCost50_50), 'EnergyCostFixed' = sum(HourlyCostFixed)) %>% 
    mutate('EnergyIndexUnit' = EnergyIndexCost / Monthly_kWh,  'EnergyUnit50_50' = EnergyCost50_50 / Monthly_kWh, 'EnergyUnitFixed' = EnergyCostFixed / Monthly_kWh) -> M_ISOCOMP_data

  
  M_ISOCOMP_data %>% 
    summarise('CostIndex' = sum(EnergyIndexCost), 'Cost50_50' = sum(EnergyCost50_50), 'CostFixed' = sum(EnergyCostFixed)) -> Annual_Cost_Estimates


```

The electric energy market in New York include energy and ancillaries with the primary market by volumn and value being the Locational Based Marginal Price (LBMP) Hourly Day Ahead market. Other markets are the Spot, Installed Capacity (ICAP) and Congestion.

Electric market participants are in wholesale electric markets to manage risk of short term price spikes. Figures 1 and 2 below show the hourly LBMP going back to 2009 and a focus on the last few months. The blue line is a linear model to show the overall trend direction, which has been decreasing for the last decade. In 2020 we see the trend changing with more upward volatility as Figure 2 shows better. For reference the 2014 polar vortex induced price spike can be see in Figure 1.

Winter and summer peaks can be seen in Figure 3 which shows the average monthly prie per MWH. Also as expected the lowest average montly costs is during the swing seasons spring and fall.

```{r Market and Building Plots, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# Plot data 


#LBMP trend over time
NYSISO_data %>% 
  ggplot(aes(x = `TimeStamp`, y = `DAM Zonal LBMP`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  scale_x_datetime() +
  theme_classic() +
  labs(x = "Date (Year)", y = "Day Ahead Hourly LBMP ($/MWH)", title = "Figure 1:" ~underline("NYSISO LBMP 2009 - Present"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )
  
#LBMP trend over time
NYSISO_data %>% 
  filter(year(TimeStamp) > 2020) %>% 
  ggplot(aes(x = `TimeStamp`, y = `DAM Zonal LBMP`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  scale_x_datetime() +
  theme_classic() +
  labs(x = "Date (Year)", y = "Day Ahead Hourly LBMP ($/MWH)", title = "Figure 2:" ~underline("NYSISO LBMP Zooming in on last 24 months"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )


#    FIGURE 3 - LBMP Monthly Average Costs 
NYSISO_data %>% 
  mutate('Year' = year(TimeStamp), 'Month' = month(TimeStamp)) %>% 
  group_by(Year, Month) %>% 
  mutate('Year-Month' = paste(as.character(Year),as.character(Month), sep = '-')) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`))  -> NYSISO_data_a
NYSISO_data_a %>% 
  mutate('ym' = ym(paste(Year, Month, sep = '-'))) -> NYSISO_data_a
NYSISO_data_a %>%  
 ggplot(aes(x = ym , y = LBMP_Avr)) +
  geom_col() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  scale_x_date(labels = date_format("%Y"), breaks = "1 year",   minor_breaks = waiver()) +
  theme(axis.text.x = element_text(angle=60, vjust = 0.5)) +
  labs(x = "Date (Year - Month)", y = "Monthly Average Day Ahead Hourly LBMP ($/MWH)", title = "Figure 3:" ~underline("Monthly Average Costs LBMP"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )
rm(NYSISO_data_a)
```

Figure 3 shows the distribution of LBMP by month over all years 2009 to present. Figure 4 shows the mean vales by month over the same time period. The takeaway here is the priminany of the winter months January and Fenuary and the summer July and August as triditionally peak cost months.

```{r, Average LBMP Plots figures-side, fig.show="hold", out.width="50%",  echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

par(mfrow=c(1,2))

#LBMP Range of LBMP by month
NYSISO_data %>% 
  mutate('Month' =as.factor(month(TimeStamp))) %>% 
  ggplot(aes(x = Month, y = `DAM Zonal LBMP`)) +
  geom_boxplot( coef = 1.0) +
  scale_x_discrete(labels=month.abb) +
  labs(x = "Date (Month)", y = "Average LBMP ($/MWH)", title = "Figure 4:" ~underline("Box and Whisker Historical Average LBMP ($/MWH)") )
  

#Look at historical average monthly pricing  
NYSISO_data %>% 
  group_by(Month = as.factor(month(`TimeStamp`))) %>% 
    summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(Month, LBMP_Avr, fill = LBMP_Avr )) +
  geom_bar(stat = "identity", position = "dodge", show.legend = FALSE, fill = "grey") +
  scale_x_discrete(labels=month.abb) +
  theme_classic() +
labs(x = "Month", y = "Monthly Average Day Ahead Hourly LBMP ($/MWH)", title = "Figure 5:" ~underline("Historical Monthly Average LBMP by Month"))

```

Figure six shows the annual distribution of LBMP for each year 2009 to present. We see the polar vortex had little influance on the mean cost for 2014 but did infact have very high short terms costs.

```{r Building Plots, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

#Yearly averages 
NYSISO_data %>% 
  mutate('Year' =as.factor(year(TimeStamp))) %>% 
  ggplot(aes(x = Year, y = `DAM Zonal LBMP`)) +
  geom_boxplot( coef = 1.0) +
  scale_x_discrete() +
  labs(x = "Year", y = "Annual Average LBMP ($/MWH)", title = "Figure 6:" ~underline("Box and Whisker Average Annual LBMP ($/MWH)") )


```
Figure 7 shows electric consumption (orange plot) and LBMP (black plot) scaled to bring both plots on one graph and both synchronized to the same timestamps. The consumption is from an  electrically cooled, steam heated 1,000,000 gsf office building in midtown Manhattan. The office buildings consumption runs counter to the LBMP. 

```{r Data Production, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

ISOCOMP_data %>% 
  mutate(LBMP = LBMP *4)  %>% 
  gather("Item", "Value", -TimeStamp) %>% 
  ggplot(aes(x = `TimeStamp`, y = Value)) +
  geom_line(aes(color = Item)) +
  scale_color_manual(values=c('grey','orange'), name = "Plot", labels = c("Comsumption", "xLBMP")) +
  labs(x = "TimeStamp", y = "Hourly LBMP ($/MWH) & Comsumption (kWh)", title = "Figure 7:" ~underline("Relationship of Comsumption to LBMP"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports & Aquacore Database")


M_ISOCOMP_data[, -c(3,6,7,8)] %>% 
  gather(key= 'Strategy', value = 'Value', -`month(TimeStamp)`) -> MonthlyComparision
MonthlyComparision$Strategy <- factor(MonthlyComparision$Strategy)
MonthlyComparision$`month(TimeStamp)` <- month.abb[MonthlyComparision$`month(TimeStamp)`]

MonthlyComparision %>% 
  ggplot(aes(x = `month(TimeStamp)`, y = Value)) +
  geom_col(aes(fill = Strategy), position = "dodge") +
  theme_classic() +
    scale_fill_discrete(name = "Strategy", labels = c("50 / 50", "Fixed", "Index")) +
  labs(x = "Month", y = "Monthly Cost($)", title = "Figure 8:" ~underline("Comparision of Strategies by month")) 
```  

```{r Annual Summeries, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

Annual_Cost_Estimates %>% 
  gather(key = 'Strategy', value = 'Value' ) -> Annual_Cost_Estimates
gsub('Cost*', '', Annual_Cost_Estimates$Strategy) -> Annual_Cost_Estimates$Strategy
Annual_Cost_Estimates$Strategy <- factor(Annual_Cost_Estimates$Strategy, levels = Annual_Cost_Estimates$Strategy[order(Annual_Cost_Estimates$Value, decreasing = TRUE)]) 

Annual_Cost_Estimates %>% 
  ggplot(aes(x = Strategy, y = Value)) +
  geom_col(aes(fill = Strategy)) +
  theme_classic() +
  labs(x = "Strategy", y = "Annual Cost($)", title = "Figure 9:" ~underline("Comparision of Strategies"))
   

# Work to make a table of the strategies 

M_ISOCOMP_data$`month(TimeStamp)` <-  month.name[M_ISOCOMP_data$`month(TimeStamp)`]
M_ISOCOMP_data %>% 
  select(1,6,7,8) %>% 
  adorn_totals(where = "row", fill = "-", na.rm = TRUE, name = "Mean") -> M_ISOCOMP_data
M_ISOCOMP_data[13,c(2:4)] <- M_ISOCOMP_data[13,c(2:4)] / 12


  kable(M_ISOCOMP_data, format = 'html',  
         col.names = c("Month", "Index", "Energy", "Fixed"),
         digits = 3, 
         align = 'lccr',
         caption = "Table 1: Monthly Unit Cost of Electricy Supply ($/kWH)") %>% 
  kable_styling(bootstrap_options = "striped",
                full_width = F) %>%
  footnote(c("2023 Electric Supply Options"))

 
```

Sensitivity with a polar vortex similar to the 2014 spike. 

```{r Polar Vortex, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

#Make more analysis to 2014 the polar vortex year. 
R <- 1
PV <- 1.5

ISOCOMP_data_Run <- ISOCOMP_data

# Multiply Jan Feb by PV defined above in this section. 
ISOCOMP_data_Run %>% 
    mutate_at(vars(c('LBMP')), ~ifelse((month(TimeStamp) == 01 | month(TimeStamp) == 02) , LBMP * PV, LBMP )) -> ISOCOMP_data_Run

 
 ISOCOMP_data_Run %>% 
    mutate(LBMP = LBMP * R) %>% 
    mutate('UnitCost50_50' = (0.5 * LBMP) + (0.5 * 83.13)) %>% 
    mutate('UnitCostFixed' = 81.80 ) %>%
    mutate('HourlyCostFixed' = (Energy * UnitCostFixed / 1000) ) %>% 
    mutate('HourlyCost50_50' = (Energy * UnitCost50_50 / 1000 ) ) %>% 
    group_by(month(TimeStamp)) %>% 
    summarise('EnergyIndexCost' = sum(LBMP), 'Monthly_kWh' = sum(Energy), 'EnergyCost50_50' = sum(HourlyCost50_50), 'EnergyCostFixed' = sum(HourlyCostFixed)) %>% 
    mutate('EnergyIndexUnit' = EnergyIndexCost / Monthly_kWh,  'EnergyUnit50_50' = EnergyCost50_50 / Monthly_kWh, 'EnergyUnitFixed' = EnergyCostFixed / Monthly_kWh) -> M_ISOCOMP_data_Run

  
  M_ISOCOMP_data_Run %>% 
    summarise('CostIndex' = sum(EnergyIndexCost), 'Cost50_50' = sum(EnergyCost50_50), 'CostFixed' = sum(EnergyCostFixed)) -> Annual_Cost_Estimates_Run
  
  
Annual_Cost_Estimates_Run %>% 
  gather(key = 'Strategy', value = 'Value' ) -> Annual_Cost_Estimates_Run
gsub('Cost*', '', Annual_Cost_Estimates_Run$Strategy) -> Annual_Cost_Estimates_Run$Strategy
Annual_Cost_Estimates_Run$Strategy <- factor(Annual_Cost_Estimates_Run$Strategy, levels = Annual_Cost_Estimates_Run$Strategy[order(Annual_Cost_Estimates_Run$Value, decreasing = TRUE)])

                                         
Annual_Cost_Estimates_Run %>% 
  ggplot(aes(x = Strategy, y = Value)) +
  geom_col(aes(fill = Strategy)) +
  theme_classic()
  
   

# Work to make a table of the strategies 

M_ISOCOMP_data_Run$`month(TimeStamp)` <-  month.name[M_ISOCOMP_data_Run$`month(TimeStamp)`]
M_ISOCOMP_data_Run %>% 
  select(1,6,7,8) %>% 
  adorn_totals(where = "row", fill = "-", na.rm = TRUE, name = "Mean") -> M_ISOCOMP_data_Run
M_ISOCOMP_data_Run[13,c(2:4)] <- M_ISOCOMP_data_Run[13,c(2:4)] / 12


  kable(M_ISOCOMP_data_Run, format = 'html',  
         col.names = c("Month", "Index", "50/50", "Fixed"),
         digits = 3, 
         align = 'lccr',
         caption = "Monthly Unit Cost of Electricy Supply ($/kWH)") %>% 
  kable_styling(bootstrap_options = "striped",
                full_width = F) %>%
  footnote(c("2023 Electric Supply Options"))


```
