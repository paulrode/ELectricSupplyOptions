---
title: "TSP Energy Supply Modeling"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---



```{r Data Setup, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

# Load packages 
my_packages <- c("tidyverse", "vroom" , "timetk", "janitor" , "glue" , "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "formattable", "scales", "kable", "kableExtra", "dplyr")   

invisible( lapply(my_packages, require, character.only = TRUE))

#Set up environment 
place <- "Home"  #Where are we working today. 
# place <- "work"

if (place == "Home"){setwd("C:/Users/paulr/Documents/R/ElectricSupplyOptions")} else {setwd("C:/Users/prode/Documents/R/ElectricSupplyOptions")}

if (!file.exists("data")) { dir.create("data")}
if (!file.exists("NYSISO_data")) { dir.create("NYSISO_data")}

rm(place, my_packages ) #Clean up

options(dplyr.summarise.inform = FALSE)  # Suppress text in Knit printout. 
```


```{r Data Read, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

# Read in data

do.call(rbind, lapply(list.files(pattern = ".csv"), read_csv)) -> NYSISO_data
NYSISO_data$`Eastern Date Hour` <- ymd_hms(NYSISO_data$`Eastern Date Hour`)
colnames(NYSISO_data)[1] <- "TimeStamp"

"Comp520" <- read_excel("data/520 Madison.xlsx",skip = 1, col_types = c("date", "numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric" ) , col_names = c("TimeStamp", "A", "B", "C", "D", "E", "F", "G", "H"), na = "NA") %>% 
  mutate("Building" = "520 Madison Avenue", .before=1) %>%  
  mutate("Elect" = A + B + C + D + E + F + G + H, .keep = "unused")  
 
Comp520 %>% 
  select(TimeStamp) %>% 
  filter(minute(TimeStamp) == 0 & second(TimeStamp) == 0)-> Comp520a

Comp520a <- Comp520a[complete.cases(Comp520a),] 

Calpine_Shaped_Block  <- read_excel("C:/Users/paulr/Documents/R/ElectricSupplyOptions/Calpine Pricing 11.1.2022.xlsx", sheet = "NY", range = "B3:K10" )

Calpine_Seasonal_Blocks  <- read_excel("C:/Users/paulr/Documents/R/ElectricSupplyOptions/Calpine Pricing 11.1.2022.xlsx", sheet = "NY", range = "B13:K20" )

Comp520 %>%
  group_by(y = year(TimeStamp), m = month(TimeStamp),d = day(TimeStamp), h = hour(TimeStamp)) %>% 
  summarise( "Elect" = sum(Elect)) %>% 
  mutate(TimeStamp = paste(y, m, d, sep = '-')) %>% 
  mutate(TimeStamp = paste( TimeStamp, h, sep = " ")) %>% 
  mutate(TimeStamp = paste( TimeStamp, ':00:00', sep = "")) %>% 
  mutate(TimeStamp = ymd_hms(TimeStamp)) -> Comp520

Comp520[c(5:6)] -> Comp520

rm(Comp520a, Comp520b, Comp520c ) #Clean up

inner_join(Comp520, NYSISO_data, by = "TimeStamp") %>% 
  na.omit() -> ISOCOMP_data
ISOCOMP_data <- unique(ISOCOMP_data)
ISOCOMP_data %>% 
  select(c(2,1,6)) -> ISOCOMP_data
colnames(ISOCOMP_data) <- c("TimeStamp", "Energy", "LBMP")

 ISOCOMP_data %>% 
    mutate('UnitCost50_50' = (0.5 * LBMP) + (0.5 * 83.13)) %>% 
    mutate('UnitCostFixed' = 81.80 ) %>%
    mutate('HourlyCostFixed' = (Energy * UnitCostFixed / 1000) ) %>% 
    mutate('HourlyCost50_50' = (Energy * UnitCost50_50 / 1000 ) ) %>% 
    group_by(month(TimeStamp)) %>% 
    summarise('EnergyIndexCost' = sum(LBMP), 'Monthly_kWh' = sum(Energy), 'EnergyCost50_50' = sum(HourlyCost50_50), 'EnergyCostFixed' = sum(HourlyCostFixed)) %>% 
    mutate('EnergyIndexUnit' = EnergyIndexCost / Monthly_kWh,  'EnergyUnit50_50' = EnergyCost50_50 / Monthly_kWh, 'EnergyUnitFixed' = EnergyCostFixed / Monthly_kWh) -> M_ISOCOMP_data

  
  M_ISOCOMP_data %>% 
    summarise('Cost50_50' = sum(EnergyCost50_50), 'CostFixed' = sum(EnergyCostFixed)) -> Annual_Cost_Estimates



```
The electric energy markets in New York is primarily the Locational Based Marginal Price (LBMP) Hourly Day Ahead market. Other markets are the Spot, Installed Capacity (ICAP) and Congestion. Most buiding owners engage in wholesale electric purchasing as a way to manage risk of short term price spikes as local utilities pass on real time costs to their rate payers. Figure 1 below show the hourly LBMP going back to 2009 for each hour of the year. The blue line is a linear model based on lease squares to show the overall trend direction, which has been decreasing for the last decade. In 2020 we see the trend changing with more opward volatility as Figure 2 shows better. For reference the 2014 polar vortex induced price spike can be see in Figure 1. 

```{r Market and Building Plots, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# Plot data 


#LBMP trend over time
NYSISO_data %>% 
  ggplot(aes(x = `TimeStamp`, y = `DAM Zonal LBMP`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  scale_x_datetime() +
  theme_classic() +
  labs(x = "Date (Year)", y = "Day Ahead Hourly LBMP ($/MWH)", title = "Figure 1:" ~underline("NYSISO LBMP 2009 - Present"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )
  
#LBMP trend over time
NYSISO_data %>% 
  filter(year(TimeStamp) > 2020) %>% 
  ggplot(aes(x = `TimeStamp`, y = `DAM Zonal LBMP`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  scale_x_datetime() +
  theme_classic() +
  labs(x = "Date (Year)", y = "Day Ahead Hourly LBMP ($/MWH)", title = "Figure 2:" ~underline("NYSISO LBMP  2020 - Present "), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )


#LBMP Monthly
NYSISO_data %>% 
  mutate('Year' = year(TimeStamp), 'Month' = month(TimeStamp)) %>% 
  group_by(Year, Month) %>% 
  mutate('Year-Month' = paste(as.character(Year),as.character(Month), sep = '-')) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`))  -> NYSISO_data_a
NYSISO_data_a %>% 
  mutate('ym' = ym(paste(Year, Month, sep = '-'))) -> NYSISO_data_a
NYSISO_data_a %>%  
 ggplot(aes(x = ym , y = LBMP_Avr)) +
  geom_col() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, ) +
  theme_classic() +
  labs(x = "Date (Year - Month)", y = "Monthly Average Day Ahead Hourly LBMP ($/MWH)", title = "Figure 3:" ~underline("Monthly Average LBMP"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports" )
rm(NYSISO_data_a)
```






```{r, Average LBMP Plots figures-side, fig.show="hold", out.width="50%",  echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

par(mfrow=c(1,2))

#LBMP Range of LBMP by month
NYSISO_data %>% 
  mutate('Month' =as.factor(month(TimeStamp))) %>% 
  ggplot(aes(x = Month, y = `DAM Zonal LBMP`)) +
  geom_boxplot( coef = 1.0) +
  scale_x_discrete(labels=month.abb) +
  labs(x = "Date (Month)", y = "Average LBMP ($/MWH)", title = "Figure 4:" ~underline("Box and Whisker Historical Average LBMP ($/MWH)") )
  

#Look at historical average monthly pricing  
NYSISO_data %>% 
  group_by(Month = as.factor(month(`TimeStamp`))) %>% 
    summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(Month, LBMP_Avr, fill = LBMP_Avr )) +
  geom_bar(stat = "identity", position = "dodge", show.legend = FALSE, fill = "grey") +
  scale_x_discrete(labels=month.abb) +
  theme_classic() +
labs(x = "Month", y = "Monthly Average Day Ahead Hourly LBMP ($/MWH)", title = "Figure 5:" ~underline("Historical Monthly Average LBMP by Month"))

```





```{r Building Plots, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

#Yearly averages 
NYSISO_data %>% 
  mutate('Year' =as.factor(year(TimeStamp))) %>% 
  ggplot(aes(x = Year, y = `DAM Zonal LBMP`)) +
  geom_boxplot( coef = 1.0) +
  scale_x_discrete() +
  labs(x = "Year", y = "Annual Average LBMP ($/MWH)", title = "Figure 6:" ~underline("Box and Whisker Average Annual LBMP ($/MWH)") )


```



```{r Data Production, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

ISOCOMP_data %>% 
  mutate(LBMP = LBMP *4)  %>% 
  gather("Item", "Value", -TimeStamp) %>% 
  ggplot(aes(x = `TimeStamp`, y = Value)) +
  geom_line(aes(color = Item)) +
  scale_color_manual(values=c('grey','orange')) +
  labs(x = "TimeStamp", y = "Hourly LBMP ($/MWH) & Comsumption (kWh)", title = "Figure 8:" ~underline("Relationship of Comsumption to LBMP"), caption = "ISO Market data from: https://www.nyiso.com/custom-reports & Aquacore Database")


M_ISOCOMP_data %>% 
  mutate('Fixed_Block' = EnergyCostFixed - EnergyCost50_50) %>% 
  ggplot(aes(x = `month(TimeStamp)`, y = Fixed_Block)) +
  geom_col(color = "grey") +
  scale_x_discrete(labels=month.abb) +
  theme_classic()
    
```


