---
title: "TSP Energy Supply Modeling"
output:
  html_document:
    df_print: paged
---



```{r Data Setup, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

# Load packages 
my_packages <- c("tidyverse", "vroom" , "timetk", "janitor" , "glue" , "tsibble" , "tidytext","lubridate", "fable", "tsibbledata", "ggplot2", "forecast", "tseries", "rio", "zoo", "readxl", "tsibbledata", "knitr", "formattable", "scales", "kable", "kableExtra", "dplyr")   

invisible( lapply(my_packages, require, character.only = TRUE))

#Set up environment 
place <- "Home"  #Where are we working today. 
# place <- "work"

if (place == "Home"){setwd("C:/Users/paulr/Documents/R/ElectricSupplyOptions")} else {setwd("C:/Users/prode/Documents/R/ElectricSupplyOptions")}

if (!file.exists("data")) { dir.create("data")}
if (!file.exists("NYSISO_data")) { dir.create("NYSISO_data")}

rm(place, my_packages ) #Clean up

options(dplyr.summarise.inform = FALSE)  # Suppress text in Knit printout. 



# Read in data

do.call(rbind, lapply(list.files(pattern = ".csv"), read_csv)) -> NYSISO_data
NYSISO_data$`Eastern Date Hour` <- ymd_hms(NYSISO_data$`Eastern Date Hour`)


# Plot data 

NYSISO_data %>% 
  ggplot(aes(x = `Eastern Date Hour`, y = `DAM Zonal LBMP`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, )


#Trend by year
NYSISO_data %>% 
  group_by(Year = year(`Eastern Date Hour`)) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(x = Year, y = LBMP_Avr)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, )


#Trend by Month
NYSISO_data %>% 
  mutate("YearMonth" = year(`Eastern Date Hour`) + month(`Eastern Date Hour`)/12) %>% 
  group_by(YearMonth) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(x = YearMonth, y = LBMP_Avr)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, )

#Look at historical pricing ranges 
NYSISO_data %>% 
  group_by(Month = month(`Eastern Date Hour`)) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(Month, LBMP_Avr, fill = LBMP_Avr )) +
  geom_bar(stat = "identity", position = "dodge")


#Look at yearly averages 
NYSISO_data %>% 
  group_by(Year = year(`Eastern Date Hour`)) %>% 
  summarise(LBMP_Avr = mean(`DAM Zonal LBMP`)) %>% 
  ggplot(aes(Year, LBMP_Avr, fill = LBMP_Avr )) +
  geom_bar(stat = "identity", position = "dodge")



```

ISO Market data from: https://www.nyiso.com/custom-reports


```{r Data Setup, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}

"Comp520" <- read_excel("data/520 Madison.xlsx",skip = 1, col_types = c("date", "numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric" ) , col_names = c("TimeStamp", "A", "B", "C", "D", "E", "F", "G", "H"), na = "NA") %>% 
  mutate("Building" = "520 Madison Avenue", .before=1) %>%  
  mutate("Elect" = A + B + C + D + E + F + G + H, .keep = "unused")  
 
Comp520 %>% 
  select(TimeStamp) %>% 
  filter(minute(TimeStamp) == 0 & second(TimeStamp) == 0) -> Comp520a

Comp520a <- Comp520a[complete.cases(Comp520a),] 

Comp520 %>% 
  group_by(y = year(TimeStamp), m = month(TimeStamp),d = day(TimeStamp), h = hour(TimeStamp)) %>% 
  summarise( "Elect" = sum(Elect)) %>% 
  mutate(TimeStamp = paste(y, m, d, sep = '-')) %>% 
  mutate(TimeStamp = paste( TimeStamp, h, sep = " ")) %>% 
  mutate(TimeStamp = paste( TimeStamp, ':00:00', sep = "")) %>% 
  mutate(TimeStamp = ymd_hms(TimeStamp)) -> Comp520

Comp520[c(5:6)] -> Comp520

rm(Comp520a, Comp520b, Comp520c ) #Clean up

colnames(NYSISO_data)[1] <- "TimeStamp"

left_join(Comp520, NYSISO_data, by = "TimeStamp") %>% 
  na.omit() -> ISOCOMP_data



ISOCOMP_data %>% 
  ggplot(aes(x = `TimeStamp`, y = `Elect`)) +
  geom_line() +
  stat_smooth(method = "lm", formula = y ~ x, show.legend = TRUE, inherit.aes = TRUE, )
           


  
  
    
```

################ UP TO HERE 


#Campus EUI for each year 
Energy %>% 
  group_by(Date = year(Month)) %>% 
  summarise(Steam_kbtu = sum(`District Steam\n(kBtu)`), Electric_kbtu = sum(`Electric - Grid\n(kBtu)`)) %>% 
  gather(key = "Item", value = "Value", -Date) %>% 
  filter(Date > 2017 & Date< 2022) -> UtilityData1

  # Make an EUI plot with kBTU vales for both  electric and steam  
UtilityData2 <- UtilityData1
apply(UtilityData2[3], 1, function(row) row / BuildingGSF ) -> UtilityData2[3]


UtilityData2 %>% 
  ggplot(aes(x = Date, y = Value, fill = Item)) +
  geom_bar(stat = "identity", position = "stack") +
  labs( title = "Energy Use Density by fuel type",
        subtitle = "Units are kBTU's per year per Gross Squar Feet") +
  xlab("Year") +
  ylab("kBTU/SF") +
  scale_fill_manual(values = c("#CC0033", "#FFFFCC"))

```
  

A look at three years of electric and steam consumption at Rockefeller Center using just annual consumption. We capture the Covid 2019 Governmental Lock Downs imposed March of 2020 to compare with the following 2 years. All values in were converted to kBTU's from kWh of electric, and from M pounds of steam. Total energy consumed in 2020 is of 2019, with no little to no physical occupancy all year the relatively small reduction consumption means that consumption is a weak function of physical occupancy. Total energy consumed in 2021 is of 2019.

The drop in energy consumption 2019 to 2020 is due primarily the last of occupants so I posit that  is associated with occupant activities, with the remaining to hvac, IT, lighting, vertical transportation, and miscellaneous plug loads, and building staff, offset somewhat by increased ventelation due to covid protocals. Interesting that both steam and electric dropped by similar amounts. Steam which is mostly used for heating, I would have thought would go up to make up for the occupient body heat that is l




